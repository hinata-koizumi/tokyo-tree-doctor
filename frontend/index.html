<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>樹木診断ダッシュボード</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans JP', sans-serif;
            background: #f8f9fa;
            color: #2c3e50;
            overflow: hidden;
        }

        /* トップバー */
        .topbar {
            height: 60px;
            background: linear-gradient(135deg, #2c5282 0%, #2d7a4e 100%);
            display: flex;
            align-items: center;
            padding: 0 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1000;
        }

        .topbar h1 {
            color: white;
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .park-select {
            margin-left: auto;
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
            font-size: 14px;
        }

        .topbar .logo {
            width: 32px;
            height: 32px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        /* メインコンテナ */
        .main-container {
            display: flex;
            height: calc(100vh - 60px);
            position: relative;
        }

        /* 左サイドパネル */
        .sidebar {
            width: 380px;
            background: white;
            box-shadow: 2px 0 8px rgba(0,0,0,0.05);
            padding: 24px;
            overflow-y: auto;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* KPIカード */
        .kpi-section {
            margin-bottom: 32px;
        }

        .section-title {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 16px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .kpi-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .kpi-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .kpi-card.danger {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border-color: #fca5a5;
        }

        .kpi-card.warning {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border-color: #fbbf24;
        }

        .kpi-card.safe {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-color: #86efac;
        }

        .kpi-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .kpi-card.danger .kpi-value {
            color: #dc2626;
        }

        .kpi-card.warning .kpi-value {
            color: #f59e0b;
        }

        .kpi-card.safe .kpi-value {
            color: #10b981;
        }

        .kpi-label {
            font-size: 12px;
            color: #6b7280;
            font-weight: 500;
        }

        /* 進捗バー */
        .progress-bar {
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            display: flex;
        }

        .progress-segment {
            transition: width 0.5s ease;
        }

        .progress-segment.danger {
            background: #dc2626;
        }

        .progress-segment.warning {
            background: #f59e0b;
        }

        .progress-segment.safe {
            background: #10b981;
        }

        /* 優先度リスト */
        .priority-section {
            margin-top: 32px;
        }

        .priority-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .priority-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.3s ease;
            cursor: pointer;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .priority-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transform: translateX(4px);
        }

        .priority-number {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }

        .priority-content {
            flex: 1;
        }

        .priority-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: #1f2937;
        }

        .priority-details {
            font-size: 12px;
            color: #6b7280;
            display: flex;
            gap: 12px;
        }

        .priority-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-danger {
            background: #fef2f2;
            color: #dc2626;
        }

        .badge-warning {
            background: #fffbeb;
            color: #f59e0b;
        }

        /* 地図コンテナ */
        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* カスタムマーカースタイル */
        .custom-marker {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .custom-marker:hover {
            transform: scale(1.2);
        }

        .marker-danger {
            background: #dc2626;
        }

        .marker-warning {
            background: #f59e0b;
        }

        .marker-safe {
            background: #10b981;
        }

        /* ポップアップスタイル */
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            padding: 0;
            overflow: hidden;
        }

        .popup-content {
            padding: 16px;
            min-width: 280px;
        }

        .popup-header {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 12px;
            color: #1f2937;
        }

        .popup-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 16px;
        }

        .popup-detail-row {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }

        .popup-detail-label {
            color: #6b7280;
        }

        .popup-detail-value {
            font-weight: 600;
            color: #1f2937;
        }

        .popup-action {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
        }

        .popup-action:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        /* モバイル対応 */
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }

            .mobile-panel {
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                background: white;
                border-radius: 24px 24px 0 0;
                padding: 24px;
                box-shadow: 0 -4px 16px rgba(0,0,0,0.1);
                z-index: 1000;
                max-height: 50vh;
                overflow-y: auto;
            }

            .mobile-kpi-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 12px;
                margin-bottom: 20px;
            }

            .mobile-kpi-item {
                text-align: center;
                padding: 12px;
                background: #f9fafb;
                border-radius: 12px;
            }

            .mobile-kpi-value {
                font-size: 24px;
                font-weight: 700;
                margin-bottom: 4px;
            }

            .mobile-kpi-label {
                font-size: 11px;
                color: #6b7280;
            }
        }

        /* ローディングアニメーション */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #e5e7eb;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- トップバー -->
    <div class="topbar">
        <h1>樹木診断ダッシュボード</h1>
        <select id="parkSelect" class="park-select">
            <option value="">公園を選択</option>
            <option value="35.6375744,139.4609936">桜ヶ丘公園</option>
            <option value="35.6383006,139.3659497">長沼公園</option>
            <option value="35.6398509,139.3788028">平山城址公園</option>
            <option value="35.5977962,139.4155167">小山田緑地</option>
            <option value="35.6062402,139.3658071">小山内裏公園</option>
            <option value="35.6604652,139.2660075">八王子霊園</option>
        </select>
        <input type="file" id="imageInput" accept="image/*" style="margin-left:12px;" />
    </div>

    <!-- メインコンテナ -->
    <div class="main-container">
        <!-- 左サイドパネル -->
        <div class="sidebar">
            <!-- KPIセクション -->
            <div class="kpi-section">
                <h2 class="section-title">診断結果サマリー <span id="parkNameDisplay" style="color: #2c5282; font-weight: 600;"></span></h2>
                
                <div class="kpi-cards">
                    <div class="kpi-card danger" onclick="filterMarkers('danger')">
                        <div class="kpi-value">8</div>
                        <div class="kpi-label">危険</div>
                    </div>
                    <div class="kpi-card warning" onclick="filterMarkers('warning')">
                        <div class="kpi-value">15</div>
                        <div class="kpi-label">要注意</div>
                    </div>
                    <div class="kpi-card safe" onclick="filterMarkers('safe')">
                        <div class="kpi-value">42</div>
                        <div class="kpi-label">健全</div>
                    </div>
                </div>

                <div class="progress-bar">
                    <div class="progress-segment danger" style="width: 12.3%"></div>
                    <div class="progress-segment warning" style="width: 23.1%"></div>
                    <div class="progress-segment safe" style="width: 64.6%"></div>
                </div>
            </div>

            <!-- 優先度リスト -->
            <div class="priority-section">
                <h2 class="section-title">対策優先度 TOP 5</h2>
                
                <div class="priority-list">
                    <div class="priority-item" onclick="focusTree(35.6895, 139.6917)">
                        <div class="priority-number">1</div>
                        <div class="priority-content">
                            <div class="priority-title">ID: TR-2024-045</div>
                            <div class="priority-details">
                                <span>VARI: 0.12</span>
                                <span>樹齢: 85年</span>
                                <span class="priority-badge badge-danger">即対応</span>
                            </div>
                        </div>
                    </div>

                    <div class="priority-item" onclick="focusTree(35.6885, 139.6925)">
                        <div class="priority-number">2</div>
                        <div class="priority-content">
                            <div class="priority-title">ID: TR-2024-018</div>
                            <div class="priority-details">
                                <span>VARI: 0.18</span>
                                <span>樹齢: 72年</span>
                                <span class="priority-badge badge-danger">即対応</span>
                            </div>
                        </div>
                    </div>

                    <div class="priority-item" onclick="focusTree(35.6905, 139.6905)">
                        <div class="priority-number">3</div>
                        <div class="priority-content">
                            <div class="priority-title">ID: TR-2024-032</div>
                            <div class="priority-details">
                                <span>VARI: 0.25</span>
                                <span>樹齢: 68年</span>
                                <span class="priority-badge badge-warning">要監視</span>
                            </div>
                        </div>
                    </div>

                    <div class="priority-item" onclick="focusTree(35.6875, 139.6935)">
                        <div class="priority-number">4</div>
                        <div class="priority-content">
                            <div class="priority-title">ID: TR-2024-089</div>
                            <div class="priority-details">
                                <span>VARI: 0.28</span>
                                <span>樹齢: 55年</span>
                                <span class="priority-badge badge-warning">要監視</span>
                            </div>
                        </div>
                    </div>

                    <div class="priority-item" onclick="focusTree(35.6915, 139.6895)">
                        <div class="priority-number">5</div>
                        <div class="priority-content">
                            <div class="priority-title">ID: TR-2024-067</div>
                            <div class="priority-details">
                                <span>VARI: 0.32</span>
                                <span>樹齢: 48年</span>
                                <span class="priority-badge badge-warning">定期観察</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 地図コンテナ -->
        <div class="map-container">
            <div id="map"></div>
            <div class="loading">
                <div class="loading-spinner"></div>
            </div>
        </div>

        <!-- モバイル用パネル（768px以下で表示） -->
        <div class="mobile-panel" style="display: none;">
            <div class="mobile-kpi-grid">
                <div class="mobile-kpi-item">
                    <div class="mobile-kpi-value" style="color: #dc2626;">8</div>
                    <div class="mobile-kpi-label">危険</div>
                </div>
                <div class="mobile-kpi-item">
                    <div class="mobile-kpi-value" style="color: #f59e0b;">15</div>
                    <div class="mobile-kpi-label">要注意</div>
                </div>
                <div class="mobile-kpi-item">
                    <div class="mobile-kpi-value" style="color: #10b981;">42</div>
                    <div class="mobile-kpi-label">健全</div>
                </div>
            </div>
            <h3 style="font-size: 14px; margin-bottom: 12px; color: #6b7280;">優先対応</h3>
            <div style="padding: 12px; background: #fef2f2; border-radius: 8px; border-left: 4px solid #dc2626;">
                <div style="font-weight: 600; margin-bottom: 4px;">TR-2024-045</div>
                <div style="font-size: 12px; color: #6b7280;">VARI: 0.12 | 即対応推奨</div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script type="module" src="analysis_client.js"></script>
    <script>
        // 公園ごとのモックデータ
        const parkData = {
            '桜ヶ丘公園': {
                summary: {
                    danger: 2,
                    warning: 4,
                    safe: 6,
                    total: 12
                },
                topPriorities: [
                    { id: 'TR-2024-045', vari: 0.042, age: 85, status: 'danger', priority: '即対応', lat: 35.6395, lng: 139.4438 },
                    { id: 'TR-2024-018', vari: 0.046, age: 72, status: 'danger', priority: '即対応', lat: 35.6393, lng: 139.4435 },
                    { id: 'TR-2024-091', vari: 0.296, age: 68, status: 'warning', priority: '要監視', lat: 35.6397, lng: 139.4440 },
                    { id: 'TR-2024-103', vari: 0.312, age: 55, status: 'warning', priority: '要監視', lat: 35.6389, lng: 139.4442 },
                    { id: 'TR-2024-087', vari: 0.325, age: 48, status: 'warning', priority: '定期観察', lat: 35.6391, lng: 139.4437 }
                ]
            },
            '長沼公園': {
                summary: {
                    danger: 1,
                    warning: 3,
                    safe: 4,
                    total: 8
                },
                topPriorities: [
                    { id: 'TR-2024-104', vari: 0.221, age: 65, status: 'danger', priority: '即対応', lat: 35.6385, lng: 139.3660 },
                    { id: 'TR-2024-032', vari: 0.037, age: 68, status: 'warning', priority: '要監視', lat: 35.6381, lng: 139.3658 },
                    { id: 'TR-2024-089', vari: 0.038, age: 55, status: 'warning', priority: '要監視', lat: 35.6384, lng: 139.3662 },
                    { id: 'TR-2024-055', vari: 0.298, age: 45, status: 'warning', priority: '定期観察', lat: 35.6382, lng: 139.3655 },
                    { id: 'TR-2024-002', vari: 0.031, age: 28, status: 'safe', priority: '経過観察', lat: 35.6380, lng: 139.3656 }
                ]
            },
            '平山城址公園': {
                summary: {
                    danger: 2,
                    warning: 5,
                    safe: 8,
                    total: 15
                },
                topPriorities: [
                    { id: 'TR-2024-127', vari: 0.046, age: 82, status: 'danger', priority: '即対応', lat: 35.6399, lng: 139.3788 },
                    { id: 'TR-2024-135', vari: 0.084, age: 70, status: 'danger', priority: '即対応', lat: 35.6397, lng: 139.3790 },
                    { id: 'TR-2024-067', vari: 0.132, age: 48, status: 'warning', priority: '要監視', lat: 35.6401, lng: 139.3786 },
                    { id: 'TR-2024-088', vari: 0.245, age: 52, status: 'warning', priority: '要監視', lat: 35.6395, lng: 139.3792 },
                    { id: 'TR-2024-099', vari: 0.278, age: 41, status: 'warning', priority: '定期観察', lat: 35.6400, lng: 139.3784 }
                ]
            },
            '小山田緑地': {
                summary: {
                    danger: 1,
                    warning: 3,
                    safe: 6,
                    total: 10
                },
                topPriorities: [
                    { id: 'TR-2024-142', vari: 0.040, age: 75, status: 'danger', priority: '即対応', lat: 35.5978, lng: 139.4155 },
                    { id: 'TR-2024-023', vari: 0.038, age: 52, status: 'warning', priority: '要監視', lat: 35.5976, lng: 139.4157 },
                    { id: 'TR-2024-078', vari: 0.039, age: 45, status: 'warning', priority: '要監視', lat: 35.5980, lng: 139.4153 },
                    { id: 'TR-2024-111', vari: 0.289, age: 38, status: 'warning', priority: '定期観察', lat: 35.5974, lng: 139.4159 },
                    { id: 'TR-2024-004', vari: 0.031, age: 30, status: 'safe', priority: '経過観察', lat: 35.5975, lng: 139.4156 }
                ]
            },
            '小山内裏公園': {
                summary: {
                    danger: 1,
                    warning: 2,
                    safe: 4,
                    total: 7
                },
                topPriorities: [
                    { id: 'TR-2024-156', vari: 0.037, age: 88, status: 'danger', priority: '即対応', lat: 35.6063, lng: 139.3658 },
                    { id: 'TR-2024-056', vari: 0.038, age: 60, status: 'warning', priority: '要監視', lat: 35.6061, lng: 139.3660 },
                    { id: 'TR-2024-077', vari: 0.265, age: 47, status: 'warning', priority: '定期観察', lat: 35.6065, lng: 139.3654 },
                    { id: 'TR-2024-005', vari: 0.036, age: 25, status: 'safe', priority: '経過観察', lat: 35.6064, lng: 139.3656 },
                    { id: 'TR-2024-033', vari: 0.412, age: 22, status: 'safe', priority: '経過観察', lat: 35.6060, lng: 139.3661 }
                ]
            },
            '八王子霊園': {
                summary: {
                    danger: 2,
                    warning: 6,
                    safe: 5,
                    total: 13
                },
                topPriorities: [
                    { id: 'TR-2024-008', vari: 0.042, age: 45, status: 'danger', priority: '即対応', lat: 35.6599, lng: 139.2610 },
                    { id: 'TR-2024-009', vari: 0.046, age: 52, status: 'danger', priority: '即対応', lat: 35.6597, lng: 139.2612 },
                    { id: 'TR-2024-098', vari: 0.030, age: 58, status: 'warning', priority: '要監視', lat: 35.6605, lng: 139.2660 },
                    { id: 'TR-2024-112', vari: 0.037, age: 50, status: 'warning', priority: '要監視', lat: 35.6603, lng: 139.2662 },
                    { id: 'TR-2024-076', vari: 0.038, age: 46, status: 'warning', priority: '定期観察', lat: 35.6607, lng: 139.2658 }
                ]
            }
        };

        // デフォルトの全体データ（公園が選択されていない時）
        const defaultData = {
            summary: {
                danger: 8,
                warning: 15,
                safe: 42,
                total: 65
            },
            topPriorities: [
                { id: 'TR-2024-045', vari: 0.12, age: 85, status: 'danger', priority: '即対応', lat: 35.6895, lng: 139.6917 },
                { id: 'TR-2024-018', vari: 0.18, age: 72, status: 'danger', priority: '即対応', lat: 35.6885, lng: 139.6925 },
                { id: 'TR-2024-032', vari: 0.25, age: 68, status: 'warning', priority: '要監視', lat: 35.6905, lng: 139.6905 },
                { id: 'TR-2024-089', vari: 0.28, age: 55, status: 'warning', priority: '要監視', lat: 35.6875, lng: 139.6935 },
                { id: 'TR-2024-067', vari: 0.32, age: 48, status: 'warning', priority: '定期観察', lat: 35.6915, lng: 139.6895 }
            ]
        };

        // 現在選択されている公園
        let currentPark = null;
        
        // グローバル変数として地図オブジェクトを保持
        let map = null;

        // 特定の樹木にフォーカス（グローバル関数として定義）
        window.focusTree = function(lat, lng) {
            if (!map) return;
            
            map.setView([lat, lng], 16, {
                animate: true,
                duration: 0.5
            });
            
            // 該当するマーカーのポップアップを開く（マーカーグループが存在する場合）
            if (window.markerGroups) {
                ['danger', 'warning', 'safe'].forEach(status => {
                    if (window.markerGroups[status]) {
                        window.markerGroups[status].eachLayer(layer => {
                            const latlng = layer.getLatLng();
                            if (Math.abs(latlng.lat - lat) < 0.0001 && Math.abs(latlng.lng - lng) < 0.0001) {
                                layer.openPopup();
                            }
                        });
                    }
                });
            }
        };

        // データ更新関数
        function updateDashboard(parkName) {
            const data = parkName ? parkData[parkName] : defaultData;
            
            if (!data) {
                console.warn('Park data not found for:', parkName);
                return;
            }

            // 公園名の表示を更新
            const parkNameDisplay = document.getElementById('parkNameDisplay');
            if (parkNameDisplay) {
                parkNameDisplay.textContent = parkName ? `- ${parkName}` : '';
            }

            // KPIカードの更新
            document.querySelector('.kpi-card.danger .kpi-value').textContent = data.summary.danger;
            document.querySelector('.kpi-card.warning .kpi-value').textContent = data.summary.warning;
            document.querySelector('.kpi-card.safe .kpi-value').textContent = data.summary.safe;

            // 進捗バーの更新
            const total = data.summary.total;
            const dangerPercent = (data.summary.danger / total * 100).toFixed(1);
            const warningPercent = (data.summary.warning / total * 100).toFixed(1);
            const safePercent = (data.summary.safe / total * 100).toFixed(1);

            document.querySelector('.progress-segment.danger').style.width = dangerPercent + '%';
            document.querySelector('.progress-segment.warning').style.width = warningPercent + '%';
            document.querySelector('.progress-segment.safe').style.width = safePercent + '%';

            // 優先度リストの更新
            const priorityList = document.querySelector('.priority-list');
            priorityList.innerHTML = '';

            data.topPriorities.forEach((item, index) => {
                const priorityItem = document.createElement('div');
                priorityItem.className = 'priority-item';
                priorityItem.onclick = () => window.focusTree(item.lat, item.lng);
                
                const badgeClass = item.status === 'danger' ? 'badge-danger' : 
                                  item.status === 'warning' ? 'badge-warning' : 'badge-safe';
                
                priorityItem.innerHTML = `
                    <div class="priority-number">${index + 1}</div>
                    <div class="priority-content">
                        <div class="priority-title">ID: ${item.id}</div>
                        <div class="priority-details">
                            <span>VARI: ${item.vari}</span>
                            <span>樹齢: ${item.age}年</span>
                            <span class="priority-badge ${badgeClass}">${item.priority}</span>
                        </div>
                    </div>
                `;
                
                priorityList.appendChild(priorityItem);
            });

            // モバイル版の更新
            const mobilePanel = document.querySelector('.mobile-panel');
            if (mobilePanel) {
                mobilePanel.querySelector('.mobile-kpi-item:nth-child(1) .mobile-kpi-value').textContent = data.summary.danger;
                mobilePanel.querySelector('.mobile-kpi-item:nth-child(2) .mobile-kpi-value').textContent = data.summary.warning;
                mobilePanel.querySelector('.mobile-kpi-item:nth-child(3) .mobile-kpi-value').textContent = data.summary.safe;
                
                // モバイル版の優先対応項目更新
                const topItem = data.topPriorities[0];
                if (topItem) {
                    const mobileTopItem = mobilePanel.querySelector('div[style*="background: #fef2f2"]');
                    if (mobileTopItem) {
                        mobileTopItem.innerHTML = `
                            <div style="font-weight: 600; margin-bottom: 4px;">${topItem.id}</div>
                            <div style="font-size: 12px; color: #6b7280;">VARI: ${topItem.vari} | ${topItem.priority}推奨</div>
                        `;
                    }
                }
            }
        }

        // Leafletが読み込まれるまで待機
        window.addEventListener('DOMContentLoaded', function() {
            // 東京都域バウンディングボックス（伊豆諸島を除く大まかな範囲）
            const tokyoBounds = L.latLngBounds([
                35.20, 138.88  // 南西端
            ], [
                35.95, 140.10  // 北東端
            ]);

            // 地図の初期化（パンを東京都域に制限）
            map = L.map('map', {
                maxBounds: tokyoBounds,      // パン制限
                maxBoundsViscosity: 1.0,     // 端で外に出られないよう完全に固定
                minZoom: 10                  // ズームアウトの下限を引き上げ
            }).setView([35.63, 139.38], 12);

            // 公園ドロップダウン選択で移動
            const parkSelect = document.getElementById('parkSelect');
            parkSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const parkName = selectedOption.text;
                const val = this.value;
                
                if (!val) {
                    // 公園が選択されていない場合は全体データを表示
                    currentPark = null;
                    updateDashboard(null);
                    return;
                }
                
                // 選択された公園のデータを更新
                currentPark = parkName;
                updateDashboard(parkName);
                
                // 地図を公園にズーム
                const [lat, lng] = val.split(',').map(Number);
                map.setView([lat, lng], 15, {
                    animate: true,
                    duration: 0.5
                });
            });

        // ベースレイヤー
        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 19
        });

        const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles © Esri'
        });

        osm.addTo(map);

        L.control.layers({ '標準': osm, '衛星写真': satellite }).addTo(map);

        // 公園データの定義
        const parks = [
            {
                name: '桜ヶ丘公園',
                center: [35.6375744, 139.4609936],
                radius: 500,
                treeCount: 12
            },
            {
                name: '長沼公園',
                center: [35.6383006, 139.3659497],
                radius: 600,
                treeCount: 8
            },
            {
                name: '平山城址公園',
                center: [35.6398509, 139.3788028],
                radius: 550,
                treeCount: 15
            },
            {
                name: '小山田緑地',
                center: [35.5977962, 139.4155167],
                radius: 700,
                treeCount: 10
            },
            {
                name: '小山内裏公園',
                center: [35.6062402, 139.3658071],
                radius: 450,
                treeCount: 7
            },
            {
                name: '八王子霊園',
                center: [35.6604652, 139.2660075],
                radius: 800,
                treeCount: 13
            }
        ];

        // 公園名ラベルのみ表示（緑色の縁取りは非表示）
        parks.forEach(park => {
            // 公園名のラベルを追加
            const parkIcon = L.divIcon({
                className: 'park-label',
                html: `
                    <div style="
                        background: rgba(255, 255, 255, 0.95);
                        padding: 6px 12px;
                        border-radius: 8px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                        font-weight: 600;
                        color: #16a34a;
                        white-space: nowrap;
                        font-size: 13px;
                    ">
                        🌳 ${park.name}
                        <div style="font-size: 11px; color: #6b7280; margin-top: 2px;">
                            診断対象: ${park.treeCount}本
                        </div>
                    </div>
                `,
                iconSize: null,
                iconAnchor: [60, 20]
            });

            L.marker(park.center, { icon: parkIcon }).addTo(map);
        });

        // サンプルデータ - 各公園に樹木を配置（VARI値に基づく）
        const treeData = [
            // 桜ヶ丘公園の樹木（VARI値が低いほど危険）
            { id: 'TR-2024-045', lat: 35.6395, lng: 139.4438, status: 'danger', vari: 0.042, age: 85, height: 22, recommendation: '即座の伐採を推奨', park: '桜ヶ丘公園' },
            { id: 'TR-2024-018', lat: 35.6393, lng: 139.4435, status: 'danger', vari: 0.046, age: 72, height: 18, recommendation: '即座の伐採を推奨', park: '桜ヶ丘公園' },
            { id: 'TR-2024-091', lat: 35.6397, lng: 139.4440, status: 'warning', vari: 0.296, age: 68, height: 16, recommendation: '3ヶ月以内の再診断', park: '桜ヶ丘公園' },
            { id: 'TR-2024-001', lat: 35.6392, lng: 139.4433, status: 'safe', vari: 0.041, age: 35, height: 12, recommendation: '問題なし', park: '桜ヶ丘公園' },
            
            // 長沼公園の樹木
            { id: 'TR-2024-104', lat: 35.6385, lng: 139.3660, status: 'danger', vari: 0.221, age: 65, height: 19, recommendation: '即座の対応が必要', park: '長沼公園' },
            { id: 'TR-2024-032', lat: 35.6381, lng: 139.3658, status: 'warning', vari: 0.037, age: 68, height: 16, recommendation: '3ヶ月以内の再診断', park: '長沼公園' },
            { id: 'TR-2024-089', lat: 35.6384, lng: 139.3662, status: 'warning', vari: 0.038, age: 55, height: 15, recommendation: '定期監視を継続', park: '長沼公園' },
            { id: 'TR-2024-002', lat: 35.6380, lng: 139.3656, status: 'safe', vari: 0.031, age: 28, height: 10, recommendation: '健全な状態', park: '長沼公園' },
            
            // 平山城址公園の樹木
            { id: 'TR-2024-127', lat: 35.6399, lng: 139.3788, status: 'danger', vari: 0.046, age: 82, height: 23, recommendation: '伐採を検討', park: '平山城址公園' },
            { id: 'TR-2024-135', lat: 35.6397, lng: 139.3790, status: 'danger', vari: 0.084, age: 70, height: 17, recommendation: '緊急対応が必要', park: '平山城址公園' },
            { id: 'TR-2024-067', lat: 35.6401, lng: 139.3786, status: 'warning', vari: 0.132, age: 48, height: 14, recommendation: '6ヶ月後に再評価', park: '平山城址公園' },
            { id: 'TR-2024-003', lat: 35.6396, lng: 139.3785, status: 'safe', vari: 0.085, age: 32, height: 11, recommendation: '良好', park: '平山城址公園' },
            
            // 小山田緑地の樹木
            { id: 'TR-2024-142', lat: 35.5978, lng: 139.4155, status: 'danger', vari: 0.040, age: 75, height: 21, recommendation: '即座の点検が必要', park: '小山田緑地' },
            { id: 'TR-2024-023', lat: 35.5976, lng: 139.4157, status: 'warning', vari: 0.038, age: 52, height: 15, recommendation: '枝の剪定を検討', park: '小山田緑地' },
            { id: 'TR-2024-078', lat: 35.5980, lng: 139.4153, status: 'warning', vari: 0.039, age: 45, height: 13, recommendation: '経過観察を継続', park: '小山田緑地' },
            { id: 'TR-2024-004', lat: 35.5975, lng: 139.4156, status: 'safe', vari: 0.031, age: 30, height: 10, recommendation: '問題なし', park: '小山田緑地' },
            
            // 小山内裏公園の樹木
            { id: 'TR-2024-156', lat: 35.6063, lng: 139.3658, status: 'danger', vari: 0.037, age: 88, height: 24, recommendation: '伐採を強く推奨', park: '小山内裏公園' },
            { id: 'TR-2024-056', lat: 35.6061, lng: 139.3660, status: 'warning', vari: 0.038, age: 60, height: 17, recommendation: '次回診断時に重点確認', park: '小山内裏公園' },
            { id: 'TR-2024-005', lat: 35.6064, lng: 139.3656, status: 'safe', vari: 0.036, age: 25, height: 9, recommendation: '非常に健全', park: '小山内裏公園' },
            
            // 八王子霊園の樹木（実際のVARI値を使用）
            { id: 'TR-2024-098', lat: 35.6605, lng: 139.2660, status: 'warning', vari: 0.030, age: 58, height: 16, recommendation: '土壌改良を検討', park: '八王子霊園' },
            { id: 'TR-2024-112', lat: 35.6603, lng: 139.2662, status: 'warning', vari: 0.037, age: 50, height: 14, recommendation: '定期的な観察が必要', park: '八王子霊園' },
            { id: 'TR-2024-076', lat: 35.6607, lng: 139.2658, status: 'warning', vari: 0.038, age: 46, height: 13, recommendation: '成長促進処置を検討', park: '八王子霊園' },
            { id: 'TR-2024-006', lat: 35.6602, lng: 139.2661, status: 'safe', vari: 0.031, age: 33, height: 11, recommendation: '良好な状態', park: '八王子霊園' },
            { id: 'TR-2024-007', lat: 35.6606, lng: 139.2659, status: 'safe', vari: 0.032, age: 38, height: 12, recommendation: '健全', park: '八王子霊園' },
            
            // 追加の八王子霊園データ（実際のVARI値）
            { id: 'TR-2024-008', lat: 35.6599, lng: 139.2610, status: 'danger', vari: 0.042, age: 45, height: 15, recommendation: '緊急点検が必要', park: '八王子霊園' },
            { id: 'TR-2024-009', lat: 35.6597, lng: 139.2612, status: 'danger', vari: 0.046, age: 52, height: 18, recommendation: '即座の対応が必要', park: '八王子霊園' },
            { id: 'TR-2024-010', lat: 35.6595, lng: 139.2614, status: 'warning', vari: 0.296, age: 38, height: 14, recommendation: '定期監視を継続', park: '八王子霊園' },
            { id: 'TR-2024-011', lat: 35.6593, lng: 139.2616, status: 'warning', vari: 0.221, age: 42, height: 16, recommendation: '枝の剪定を検討', park: '八王子霊園' },
            { id: 'TR-2024-012', lat: 35.6591, lng: 139.2618, status: 'safe', vari: 0.037, age: 29, height: 11, recommendation: '問題なし', park: '八王子霊園' }
        ];

        // マーカーグループ（グローバル変数として保持）
        window.markerGroups = {
            danger: L.markerClusterGroup({ disableClusteringAtZoom: 17 }),
            warning: L.markerClusterGroup({ disableClusteringAtZoom: 17 }),
            safe: L.markerClusterGroup({ disableClusteringAtZoom: 17 })
        };

        // マーカーの作成
        treeData.forEach(tree => {
            const markerIcon = L.divIcon({
                className: `custom-marker marker-${tree.status}`,
                iconSize: [24, 24]
            });

            const marker = L.marker([tree.lat, tree.lng], { icon: markerIcon });
            
            // ポップアップの作成
            const popupContent = `
                <div class="popup-content">
                    <div class="popup-header">樹木 ${tree.id}</div>
                    <div class="popup-details">
                        <div class="popup-detail-row">
                            <span class="popup-detail-label">所在地</span>
                            <span class="popup-detail-value">${tree.park || '未設定'}</span>
                        </div>
                        <div class="popup-detail-row">
                            <span class="popup-detail-label">状態</span>
                            <span class="popup-detail-value" style="color: ${
                                tree.status === 'danger' ? '#dc2626' : 
                                tree.status === 'warning' ? '#f59e0b' : '#10b981'
                            }">
                                ${tree.status === 'danger' ? '危険' : 
                                  tree.status === 'warning' ? '要注意' : '健全'}
                            </span>
                        </div>
                        <div class="popup-detail-row">
                            <span class="popup-detail-label">VARI値</span>
                            <span class="popup-detail-value">${tree.vari}</span>
                        </div>
                        <div class="popup-detail-row">
                            <span class="popup-detail-label">樹齢</span>
                            <span class="popup-detail-value">${tree.age}年</span>
                        </div>
                        <div class="popup-detail-row">
                            <span class="popup-detail-label">樹高</span>
                            <span class="popup-detail-value">${tree.height}m</span>
                        </div>
                        <div class="popup-detail-row">
                            <span class="popup-detail-label">推奨対策</span>
                            <span class="popup-detail-value">${tree.recommendation}</span>
                        </div>
                    </div>
                    <button class="popup-action" onclick="showDetails('${tree.id}')">
                        詳細レポートを表示
                    </button>
                </div>
            `;
            
            marker.bindPopup(popupContent);
            window.markerGroups[tree.status].addLayer(marker);
        });

        // すべてのマーカーを地図に追加
        Object.values(window.markerGroups).forEach(group => {
            group.addTo(map);
        });

        // マーカーフィルタリング機能
        let currentFilter = 'all';
        
        window.filterMarkers = function(status) {
            if (currentFilter === status) {
                // 同じフィルターをクリックしたら全表示に戻す
                Object.values(window.markerGroups).forEach(group => {
                    group.addTo(map);
                });
                currentFilter = 'all';
            } else {
                // 選択したステータスのマーカーのみ表示
                Object.keys(window.markerGroups).forEach(key => {
                    if (key === status) {
                        window.markerGroups[key].addTo(map);
                    } else {
                        map.removeLayer(window.markerGroups[key]);
                    }
                });
                currentFilter = status;
            }
        };

        // 詳細レポート表示（グローバル関数として定義）
        window.showDetails = function(id) {
            alert(`樹木 ${id} の詳細レポートを表示します。\n（実際の実装では別画面やモーダルで詳細情報を表示）`);
        };



        // モバイル対応の処理
        function checkMobile() {
            const mobilePanel = document.querySelector('.mobile-panel');
            if (window.innerWidth <= 768) {
                mobilePanel.style.display = 'block';
            } else {
                mobilePanel.style.display = 'none';
            }
        }

        window.addEventListener('resize', checkMobile);
        checkMobile();

        // 地図のサイズ調整
        setTimeout(() => {
            map.invalidateSize();
        }, 100);

        const imageInput = document.getElementById('imageInput');
        imageInput.addEventListener('change', async (e) => {
          const file = e.target.files[0];
          if (!file) return;
          try {
            document.querySelector('.loading').style.display = 'block';
            await analyzeAndDraw(file, window.map || map, { gsd_m_per_px: 0.05 });
          } catch (err) {
            alert('分析エラー: ' + err);
          } finally {
            document.querySelector('.loading').style.display = 'none';
          }
        });
        });
    </script>
</body>
</html>