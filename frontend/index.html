<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨¹æœ¨è¨ºæ–­ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans JP', sans-serif;
            background: #f8f9fa;
            color: #2c3e50;
            overflow: hidden;
        }

        /* ãƒˆãƒƒãƒ—ãƒãƒ¼ */
        .topbar {
            height: 60px;
            background: linear-gradient(135deg, #2c5282 0%, #2d7a4e 100%);
            display: flex;
            align-items: center;
            padding: 0 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1000;
        }

        .topbar h1 {
            color: white;
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .park-select {
            margin-left: auto;
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
            font-size: 14px;
        }

        .topbar .logo {
            width: 32px;
            height: 32px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
        .main-container {
            display: flex;
            height: calc(100vh - 60px);
            position: relative;
        }

        /* å·¦ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ« */
        .sidebar {
            width: 380px;
            background: white;
            box-shadow: 2px 0 8px rgba(0,0,0,0.05);
            padding: 24px;
            overflow-y: auto;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* KPIã‚«ãƒ¼ãƒ‰ */
        .kpi-section {
            margin-bottom: 32px;
        }

        .section-title {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 16px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .kpi-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .kpi-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .kpi-card.danger {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border-color: #fca5a5;
        }

        .kpi-card.warning {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border-color: #fbbf24;
        }

        .kpi-card.safe {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-color: #86efac;
        }

        .kpi-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .kpi-card.danger .kpi-value {
            color: #dc2626;
        }

        .kpi-card.warning .kpi-value {
            color: #f59e0b;
        }

        .kpi-card.safe .kpi-value {
            color: #10b981;
        }

        .kpi-label {
            font-size: 12px;
            color: #6b7280;
            font-weight: 500;
        }

        /* é€²æ—ãƒãƒ¼ */
        .progress-bar {
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            display: flex;
        }

        .progress-segment {
            transition: width 0.5s ease;
        }

        .progress-segment.danger {
            background: #dc2626;
        }

        .progress-segment.warning {
            background: #f59e0b;
        }

        .progress-segment.safe {
            background: #10b981;
        }

        /* å„ªå…ˆåº¦ãƒªã‚¹ãƒˆ */
        .priority-section {
            margin-top: 32px;
        }

        .priority-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .priority-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.3s ease;
            cursor: pointer;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .priority-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transform: translateX(4px);
        }

        .priority-number {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }

        .priority-content {
            flex: 1;
        }

        .priority-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: #1f2937;
        }

        .priority-details {
            font-size: 12px;
            color: #6b7280;
            display: flex;
            gap: 12px;
        }

        .priority-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-danger {
            background: #fef2f2;
            color: #dc2626;
        }

        .badge-warning {
            background: #fffbeb;
            color: #f59e0b;
        }

        /* åœ°å›³ã‚³ãƒ³ãƒ†ãƒŠ */
        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ¼ã‚«ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ« */
        .custom-marker {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .custom-marker:hover {
            transform: scale(1.2);
        }

        .marker-danger {
            background: #dc2626;
        }

        .marker-warning {
            background: #f59e0b;
        }

        .marker-safe {
            background: #10b981;
        }

        /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚¹ã‚¿ã‚¤ãƒ« */
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            padding: 0;
            overflow: hidden;
        }

        .popup-content {
            padding: 16px;
            min-width: 280px;
        }

        .popup-header {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 12px;
            color: #1f2937;
        }

        .popup-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 16px;
        }

        .popup-detail-row {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }

        .popup-detail-label {
            color: #6b7280;
        }

        .popup-detail-value {
            font-weight: 600;
            color: #1f2937;
        }

        .popup-action {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
        }

        .popup-action:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }

            .mobile-panel {
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                background: white;
                border-radius: 24px 24px 0 0;
                padding: 24px;
                box-shadow: 0 -4px 16px rgba(0,0,0,0.1);
                z-index: 1000;
                max-height: 50vh;
                overflow-y: auto;
            }

            .mobile-kpi-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 12px;
                margin-bottom: 20px;
            }

            .mobile-kpi-item {
                text-align: center;
                padding: 12px;
                background: #f9fafb;
                border-radius: 12px;
            }

            .mobile-kpi-value {
                font-size: 24px;
                font-weight: 700;
                margin-bottom: 4px;
            }

            .mobile-kpi-label {
                font-size: 11px;
                color: #6b7280;
            }
        }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #e5e7eb;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- ãƒˆãƒƒãƒ—ãƒãƒ¼ -->
    <div class="topbar">
        <h1>æ¨¹æœ¨è¨ºæ–­ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
        <select id="parkSelect" class="park-select">
            <option value="">å…¬åœ’ã‚’é¸æŠ</option>
            <option value="35.6375744,139.4609936">æ¡œãƒ¶ä¸˜å…¬åœ’</option>
            <option value="35.6383006,139.3659497">é•·æ²¼å…¬åœ’</option>
            <option value="35.6398509,139.3788028">å¹³å±±åŸå€å…¬åœ’</option>
            <option value="35.5977962,139.4155167">å°å±±ç”°ç·‘åœ°</option>
            <option value="35.6062402,139.3658071">å°å±±å†…è£å…¬åœ’</option>
            <option value="35.6604652,139.2660075">å…«ç‹å­éœŠåœ’</option>
        </select>
        <input type="file" id="imageInput" accept="image/*" style="margin-left:12px;" />
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div class="main-container">
        <!-- å·¦ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ« -->
        <div class="sidebar">
            <!-- KPIã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="kpi-section">
                <h2 class="section-title">è¨ºæ–­çµæœã‚µãƒãƒªãƒ¼ <span id="parkNameDisplay" style="color: #2c5282; font-weight: 600;"></span></h2>
                
                <div class="kpi-cards">
                    <div class="kpi-card danger" onclick="filterMarkers('danger')">
                        <div class="kpi-value">8</div>
                        <div class="kpi-label">å±é™º</div>
                    </div>
                    <div class="kpi-card warning" onclick="filterMarkers('warning')">
                        <div class="kpi-value">15</div>
                        <div class="kpi-label">è¦æ³¨æ„</div>
                    </div>
                    <div class="kpi-card safe" onclick="filterMarkers('safe')">
                        <div class="kpi-value">42</div>
                        <div class="kpi-label">å¥å…¨</div>
                    </div>
                </div>

                <div class="progress-bar">
                    <div class="progress-segment danger" style="width: 12.3%"></div>
                    <div class="progress-segment warning" style="width: 23.1%"></div>
                    <div class="progress-segment safe" style="width: 64.6%"></div>
                </div>
            </div>

            <!-- å„ªå…ˆåº¦ãƒªã‚¹ãƒˆ -->
            <div class="priority-section">
                <h2 class="section-title">å¯¾ç­–å„ªå…ˆåº¦ TOP 5</h2>
                
                <div class="priority-list">
                    <div class="priority-item" onclick="focusTree(35.6895, 139.6917)">
                        <div class="priority-number">1</div>
                        <div class="priority-content">
                            <div class="priority-title">ID: TR-2024-045</div>
                            <div class="priority-details">
                                <span>VARI: 0.12</span>
                                <span>æ¨¹é½¢: 85å¹´</span>
                                <span class="priority-badge badge-danger">å³å¯¾å¿œ</span>
                            </div>
                        </div>
                    </div>

                    <div class="priority-item" onclick="focusTree(35.6885, 139.6925)">
                        <div class="priority-number">2</div>
                        <div class="priority-content">
                            <div class="priority-title">ID: TR-2024-018</div>
                            <div class="priority-details">
                                <span>VARI: 0.18</span>
                                <span>æ¨¹é½¢: 72å¹´</span>
                                <span class="priority-badge badge-danger">å³å¯¾å¿œ</span>
                            </div>
                        </div>
                    </div>

                    <div class="priority-item" onclick="focusTree(35.6905, 139.6905)">
                        <div class="priority-number">3</div>
                        <div class="priority-content">
                            <div class="priority-title">ID: TR-2024-032</div>
                            <div class="priority-details">
                                <span>VARI: 0.25</span>
                                <span>æ¨¹é½¢: 68å¹´</span>
                                <span class="priority-badge badge-warning">è¦ç›£è¦–</span>
                            </div>
                        </div>
                    </div>

                    <div class="priority-item" onclick="focusTree(35.6875, 139.6935)">
                        <div class="priority-number">4</div>
                        <div class="priority-content">
                            <div class="priority-title">ID: TR-2024-089</div>
                            <div class="priority-details">
                                <span>VARI: 0.28</span>
                                <span>æ¨¹é½¢: 55å¹´</span>
                                <span class="priority-badge badge-warning">è¦ç›£è¦–</span>
                            </div>
                        </div>
                    </div>

                    <div class="priority-item" onclick="focusTree(35.6915, 139.6895)">
                        <div class="priority-number">5</div>
                        <div class="priority-content">
                            <div class="priority-title">ID: TR-2024-067</div>
                            <div class="priority-details">
                                <span>VARI: 0.32</span>
                                <span>æ¨¹é½¢: 48å¹´</span>
                                <span class="priority-badge badge-warning">å®šæœŸè¦³å¯Ÿ</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- åœ°å›³ã‚³ãƒ³ãƒ†ãƒŠ -->
        <div class="map-container">
            <div id="map"></div>
            <div class="loading">
                <div class="loading-spinner"></div>
            </div>
        </div>

        <!-- ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒ‘ãƒãƒ«ï¼ˆ768pxä»¥ä¸‹ã§è¡¨ç¤ºï¼‰ -->
        <div class="mobile-panel" style="display: none;">
            <div class="mobile-kpi-grid">
                <div class="mobile-kpi-item">
                    <div class="mobile-kpi-value" style="color: #dc2626;">8</div>
                    <div class="mobile-kpi-label">å±é™º</div>
                </div>
                <div class="mobile-kpi-item">
                    <div class="mobile-kpi-value" style="color: #f59e0b;">15</div>
                    <div class="mobile-kpi-label">è¦æ³¨æ„</div>
                </div>
                <div class="mobile-kpi-item">
                    <div class="mobile-kpi-value" style="color: #10b981;">42</div>
                    <div class="mobile-kpi-label">å¥å…¨</div>
                </div>
            </div>
            <h3 style="font-size: 14px; margin-bottom: 12px; color: #6b7280;">å„ªå…ˆå¯¾å¿œ</h3>
            <div style="padding: 12px; background: #fef2f2; border-radius: 8px; border-left: 4px solid #dc2626;">
                <div style="font-weight: 600; margin-bottom: 4px;">TR-2024-045</div>
                <div style="font-size: 12px; color: #6b7280;">VARI: 0.12 | å³å¯¾å¿œæ¨å¥¨</div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script type="module" src="analysis_client.js"></script>
    <script>
        // å…¬åœ’ã”ã¨ã®ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿
        const parkData = {
            'æ¡œãƒ¶ä¸˜å…¬åœ’': {
                summary: {
                    danger: 2,
                    warning: 4,
                    safe: 6,
                    total: 12
                },
                topPriorities: [
                    { id: 'TR-2024-045', vari: 0.042, age: 85, status: 'danger', priority: 'å³å¯¾å¿œ', lat: 35.6395, lng: 139.4438 },
                    { id: 'TR-2024-018', vari: 0.046, age: 72, status: 'danger', priority: 'å³å¯¾å¿œ', lat: 35.6393, lng: 139.4435 },
                    { id: 'TR-2024-091', vari: 0.296, age: 68, status: 'warning', priority: 'è¦ç›£è¦–', lat: 35.6397, lng: 139.4440 },
                    { id: 'TR-2024-103', vari: 0.312, age: 55, status: 'warning', priority: 'è¦ç›£è¦–', lat: 35.6389, lng: 139.4442 },
                    { id: 'TR-2024-087', vari: 0.325, age: 48, status: 'warning', priority: 'å®šæœŸè¦³å¯Ÿ', lat: 35.6391, lng: 139.4437 }
                ]
            },
            'é•·æ²¼å…¬åœ’': {
                summary: {
                    danger: 1,
                    warning: 3,
                    safe: 4,
                    total: 8
                },
                topPriorities: [
                    { id: 'TR-2024-104', vari: 0.221, age: 65, status: 'danger', priority: 'å³å¯¾å¿œ', lat: 35.6385, lng: 139.3660 },
                    { id: 'TR-2024-032', vari: 0.037, age: 68, status: 'warning', priority: 'è¦ç›£è¦–', lat: 35.6381, lng: 139.3658 },
                    { id: 'TR-2024-089', vari: 0.038, age: 55, status: 'warning', priority: 'è¦ç›£è¦–', lat: 35.6384, lng: 139.3662 },
                    { id: 'TR-2024-055', vari: 0.298, age: 45, status: 'warning', priority: 'å®šæœŸè¦³å¯Ÿ', lat: 35.6382, lng: 139.3655 },
                    { id: 'TR-2024-002', vari: 0.031, age: 28, status: 'safe', priority: 'çµŒéè¦³å¯Ÿ', lat: 35.6380, lng: 139.3656 }
                ]
            },
            'å¹³å±±åŸå€å…¬åœ’': {
                summary: {
                    danger: 2,
                    warning: 5,
                    safe: 8,
                    total: 15
                },
                topPriorities: [
                    { id: 'TR-2024-127', vari: 0.046, age: 82, status: 'danger', priority: 'å³å¯¾å¿œ', lat: 35.6399, lng: 139.3788 },
                    { id: 'TR-2024-135', vari: 0.084, age: 70, status: 'danger', priority: 'å³å¯¾å¿œ', lat: 35.6397, lng: 139.3790 },
                    { id: 'TR-2024-067', vari: 0.132, age: 48, status: 'warning', priority: 'è¦ç›£è¦–', lat: 35.6401, lng: 139.3786 },
                    { id: 'TR-2024-088', vari: 0.245, age: 52, status: 'warning', priority: 'è¦ç›£è¦–', lat: 35.6395, lng: 139.3792 },
                    { id: 'TR-2024-099', vari: 0.278, age: 41, status: 'warning', priority: 'å®šæœŸè¦³å¯Ÿ', lat: 35.6400, lng: 139.3784 }
                ]
            },
            'å°å±±ç”°ç·‘åœ°': {
                summary: {
                    danger: 1,
                    warning: 3,
                    safe: 6,
                    total: 10
                },
                topPriorities: [
                    { id: 'TR-2024-142', vari: 0.040, age: 75, status: 'danger', priority: 'å³å¯¾å¿œ', lat: 35.5978, lng: 139.4155 },
                    { id: 'TR-2024-023', vari: 0.038, age: 52, status: 'warning', priority: 'è¦ç›£è¦–', lat: 35.5976, lng: 139.4157 },
                    { id: 'TR-2024-078', vari: 0.039, age: 45, status: 'warning', priority: 'è¦ç›£è¦–', lat: 35.5980, lng: 139.4153 },
                    { id: 'TR-2024-111', vari: 0.289, age: 38, status: 'warning', priority: 'å®šæœŸè¦³å¯Ÿ', lat: 35.5974, lng: 139.4159 },
                    { id: 'TR-2024-004', vari: 0.031, age: 30, status: 'safe', priority: 'çµŒéè¦³å¯Ÿ', lat: 35.5975, lng: 139.4156 }
                ]
            },
            'å°å±±å†…è£å…¬åœ’': {
                summary: {
                    danger: 1,
                    warning: 2,
                    safe: 4,
                    total: 7
                },
                topPriorities: [
                    { id: 'TR-2024-156', vari: 0.037, age: 88, status: 'danger', priority: 'å³å¯¾å¿œ', lat: 35.6063, lng: 139.3658 },
                    { id: 'TR-2024-056', vari: 0.038, age: 60, status: 'warning', priority: 'è¦ç›£è¦–', lat: 35.6061, lng: 139.3660 },
                    { id: 'TR-2024-077', vari: 0.265, age: 47, status: 'warning', priority: 'å®šæœŸè¦³å¯Ÿ', lat: 35.6065, lng: 139.3654 },
                    { id: 'TR-2024-005', vari: 0.036, age: 25, status: 'safe', priority: 'çµŒéè¦³å¯Ÿ', lat: 35.6064, lng: 139.3656 },
                    { id: 'TR-2024-033', vari: 0.412, age: 22, status: 'safe', priority: 'çµŒéè¦³å¯Ÿ', lat: 35.6060, lng: 139.3661 }
                ]
            },
            'å…«ç‹å­éœŠåœ’': {
                summary: {
                    danger: 2,
                    warning: 6,
                    safe: 5,
                    total: 13
                },
                topPriorities: [
                    { id: 'TR-2024-008', vari: 0.042, age: 45, status: 'danger', priority: 'å³å¯¾å¿œ', lat: 35.6599, lng: 139.2610 },
                    { id: 'TR-2024-009', vari: 0.046, age: 52, status: 'danger', priority: 'å³å¯¾å¿œ', lat: 35.6597, lng: 139.2612 },
                    { id: 'TR-2024-098', vari: 0.030, age: 58, status: 'warning', priority: 'è¦ç›£è¦–', lat: 35.6605, lng: 139.2660 },
                    { id: 'TR-2024-112', vari: 0.037, age: 50, status: 'warning', priority: 'è¦ç›£è¦–', lat: 35.6603, lng: 139.2662 },
                    { id: 'TR-2024-076', vari: 0.038, age: 46, status: 'warning', priority: 'å®šæœŸè¦³å¯Ÿ', lat: 35.6607, lng: 139.2658 }
                ]
            }
        };

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å…¨ä½“ãƒ‡ãƒ¼ã‚¿ï¼ˆå…¬åœ’ãŒé¸æŠã•ã‚Œã¦ã„ãªã„æ™‚ï¼‰
        const defaultData = {
            summary: {
                danger: 8,
                warning: 15,
                safe: 42,
                total: 65
            },
            topPriorities: [
                { id: 'TR-2024-045', vari: 0.12, age: 85, status: 'danger', priority: 'å³å¯¾å¿œ', lat: 35.6895, lng: 139.6917 },
                { id: 'TR-2024-018', vari: 0.18, age: 72, status: 'danger', priority: 'å³å¯¾å¿œ', lat: 35.6885, lng: 139.6925 },
                { id: 'TR-2024-032', vari: 0.25, age: 68, status: 'warning', priority: 'è¦ç›£è¦–', lat: 35.6905, lng: 139.6905 },
                { id: 'TR-2024-089', vari: 0.28, age: 55, status: 'warning', priority: 'è¦ç›£è¦–', lat: 35.6875, lng: 139.6935 },
                { id: 'TR-2024-067', vari: 0.32, age: 48, status: 'warning', priority: 'å®šæœŸè¦³å¯Ÿ', lat: 35.6915, lng: 139.6895 }
            ]
        };

        // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹å…¬åœ’
        let currentPark = null;
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦åœ°å›³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¿æŒ
        let map = null;

        // ç‰¹å®šã®æ¨¹æœ¨ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©ï¼‰
        window.focusTree = function(lat, lng) {
            if (!map) return;
            
            map.setView([lat, lng], 16, {
                animate: true,
                duration: 0.5
            });
            
            // è©²å½“ã™ã‚‹ãƒãƒ¼ã‚«ãƒ¼ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‹ãï¼ˆãƒãƒ¼ã‚«ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ãŒå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
            if (window.markerGroups) {
                ['danger', 'warning', 'safe'].forEach(status => {
                    if (window.markerGroups[status]) {
                        window.markerGroups[status].eachLayer(layer => {
                            const latlng = layer.getLatLng();
                            if (Math.abs(latlng.lat - lat) < 0.0001 && Math.abs(latlng.lng - lng) < 0.0001) {
                                layer.openPopup();
                            }
                        });
                    }
                });
            }
        };

        // ãƒ‡ãƒ¼ã‚¿æ›´æ–°é–¢æ•°
        function updateDashboard(parkName) {
            const data = parkName ? parkData[parkName] : defaultData;
            
            if (!data) {
                console.warn('Park data not found for:', parkName);
                return;
            }

            // å…¬åœ’åã®è¡¨ç¤ºã‚’æ›´æ–°
            const parkNameDisplay = document.getElementById('parkNameDisplay');
            if (parkNameDisplay) {
                parkNameDisplay.textContent = parkName ? `- ${parkName}` : '';
            }

            // KPIã‚«ãƒ¼ãƒ‰ã®æ›´æ–°
            document.querySelector('.kpi-card.danger .kpi-value').textContent = data.summary.danger;
            document.querySelector('.kpi-card.warning .kpi-value').textContent = data.summary.warning;
            document.querySelector('.kpi-card.safe .kpi-value').textContent = data.summary.safe;

            // é€²æ—ãƒãƒ¼ã®æ›´æ–°
            const total = data.summary.total;
            const dangerPercent = (data.summary.danger / total * 100).toFixed(1);
            const warningPercent = (data.summary.warning / total * 100).toFixed(1);
            const safePercent = (data.summary.safe / total * 100).toFixed(1);

            document.querySelector('.progress-segment.danger').style.width = dangerPercent + '%';
            document.querySelector('.progress-segment.warning').style.width = warningPercent + '%';
            document.querySelector('.progress-segment.safe').style.width = safePercent + '%';

            // å„ªå…ˆåº¦ãƒªã‚¹ãƒˆã®æ›´æ–°
            const priorityList = document.querySelector('.priority-list');
            priorityList.innerHTML = '';

            data.topPriorities.forEach((item, index) => {
                const priorityItem = document.createElement('div');
                priorityItem.className = 'priority-item';
                priorityItem.onclick = () => window.focusTree(item.lat, item.lng);
                
                const badgeClass = item.status === 'danger' ? 'badge-danger' : 
                                  item.status === 'warning' ? 'badge-warning' : 'badge-safe';
                
                priorityItem.innerHTML = `
                    <div class="priority-number">${index + 1}</div>
                    <div class="priority-content">
                        <div class="priority-title">ID: ${item.id}</div>
                        <div class="priority-details">
                            <span>VARI: ${item.vari}</span>
                            <span>æ¨¹é½¢: ${item.age}å¹´</span>
                            <span class="priority-badge ${badgeClass}">${item.priority}</span>
                        </div>
                    </div>
                `;
                
                priorityList.appendChild(priorityItem);
            });

            // ãƒ¢ãƒã‚¤ãƒ«ç‰ˆã®æ›´æ–°
            const mobilePanel = document.querySelector('.mobile-panel');
            if (mobilePanel) {
                mobilePanel.querySelector('.mobile-kpi-item:nth-child(1) .mobile-kpi-value').textContent = data.summary.danger;
                mobilePanel.querySelector('.mobile-kpi-item:nth-child(2) .mobile-kpi-value').textContent = data.summary.warning;
                mobilePanel.querySelector('.mobile-kpi-item:nth-child(3) .mobile-kpi-value').textContent = data.summary.safe;
                
                // ãƒ¢ãƒã‚¤ãƒ«ç‰ˆã®å„ªå…ˆå¯¾å¿œé …ç›®æ›´æ–°
                const topItem = data.topPriorities[0];
                if (topItem) {
                    const mobileTopItem = mobilePanel.querySelector('div[style*="background: #fef2f2"]');
                    if (mobileTopItem) {
                        mobileTopItem.innerHTML = `
                            <div style="font-weight: 600; margin-bottom: 4px;">${topItem.id}</div>
                            <div style="font-size: 12px; color: #6b7280;">VARI: ${topItem.vari} | ${topItem.priority}æ¨å¥¨</div>
                        `;
                    }
                }
            }
        }

        // LeafletãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ã¾ã§å¾…æ©Ÿ
        window.addEventListener('DOMContentLoaded', function() {
            // æ±äº¬éƒ½åŸŸãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ï¼ˆä¼Šè±†è«¸å³¶ã‚’é™¤ãå¤§ã¾ã‹ãªç¯„å›²ï¼‰
            const tokyoBounds = L.latLngBounds([
                35.20, 138.88  // å—è¥¿ç«¯
            ], [
                35.95, 140.10  // åŒ—æ±ç«¯
            ]);

            // åœ°å›³ã®åˆæœŸåŒ–ï¼ˆãƒ‘ãƒ³ã‚’æ±äº¬éƒ½åŸŸã«åˆ¶é™ï¼‰
            map = L.map('map', {
                maxBounds: tokyoBounds,      // ãƒ‘ãƒ³åˆ¶é™
                maxBoundsViscosity: 1.0,     // ç«¯ã§å¤–ã«å‡ºã‚‰ã‚Œãªã„ã‚ˆã†å®Œå…¨ã«å›ºå®š
                minZoom: 10                  // ã‚ºãƒ¼ãƒ ã‚¢ã‚¦ãƒˆã®ä¸‹é™ã‚’å¼•ãä¸Šã’
            }).setView([35.63, 139.38], 12);

            // å…¬åœ’ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³é¸æŠã§ç§»å‹•
            const parkSelect = document.getElementById('parkSelect');
            parkSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const parkName = selectedOption.text;
                const val = this.value;
                
                if (!val) {
                    // å…¬åœ’ãŒé¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯å…¨ä½“ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
                    currentPark = null;
                    updateDashboard(null);
                    return;
                }
                
                // é¸æŠã•ã‚ŒãŸå…¬åœ’ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
                currentPark = parkName;
                updateDashboard(parkName);
                
                // åœ°å›³ã‚’å…¬åœ’ã«ã‚ºãƒ¼ãƒ 
                const [lat, lng] = val.split(',').map(Number);
                map.setView([lat, lng], 15, {
                    animate: true,
                    duration: 0.5
                });
            });

        // ãƒ™ãƒ¼ã‚¹ãƒ¬ã‚¤ãƒ¤ãƒ¼
        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors',
            maxZoom: 19
        });

        const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles Â© Esri'
        });

        osm.addTo(map);

        L.control.layers({ 'æ¨™æº–': osm, 'è¡›æ˜Ÿå†™çœŸ': satellite }).addTo(map);

        // å…¬åœ’ãƒ‡ãƒ¼ã‚¿ã®å®šç¾©
        const parks = [
            {
                name: 'æ¡œãƒ¶ä¸˜å…¬åœ’',
                center: [35.6375744, 139.4609936],
                radius: 500,
                treeCount: 12
            },
            {
                name: 'é•·æ²¼å…¬åœ’',
                center: [35.6383006, 139.3659497],
                radius: 600,
                treeCount: 8
            },
            {
                name: 'å¹³å±±åŸå€å…¬åœ’',
                center: [35.6398509, 139.3788028],
                radius: 550,
                treeCount: 15
            },
            {
                name: 'å°å±±ç”°ç·‘åœ°',
                center: [35.5977962, 139.4155167],
                radius: 700,
                treeCount: 10
            },
            {
                name: 'å°å±±å†…è£å…¬åœ’',
                center: [35.6062402, 139.3658071],
                radius: 450,
                treeCount: 7
            },
            {
                name: 'å…«ç‹å­éœŠåœ’',
                center: [35.6604652, 139.2660075],
                radius: 800,
                treeCount: 13
            }
        ];

        // å…¬åœ’åãƒ©ãƒ™ãƒ«ã®ã¿è¡¨ç¤ºï¼ˆç·‘è‰²ã®ç¸å–ã‚Šã¯éè¡¨ç¤ºï¼‰
        parks.forEach(park => {
            // å…¬åœ’åã®ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
            const parkIcon = L.divIcon({
                className: 'park-label',
                html: `
                    <div style="
                        background: rgba(255, 255, 255, 0.95);
                        padding: 6px 12px;
                        border-radius: 8px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                        font-weight: 600;
                        color: #16a34a;
                        white-space: nowrap;
                        font-size: 13px;
                    ">
                        ğŸŒ³ ${park.name}
                        <div style="font-size: 11px; color: #6b7280; margin-top: 2px;">
                            è¨ºæ–­å¯¾è±¡: ${park.treeCount}æœ¬
                        </div>
                    </div>
                `,
                iconSize: null,
                iconAnchor: [60, 20]
            });

            L.marker(park.center, { icon: parkIcon }).addTo(map);
        });

        // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ - å„å…¬åœ’ã«æ¨¹æœ¨ã‚’é…ç½®ï¼ˆVARIå€¤ã«åŸºã¥ãï¼‰
        const treeData = [
            // æ¡œãƒ¶ä¸˜å…¬åœ’ã®æ¨¹æœ¨ï¼ˆVARIå€¤ãŒä½ã„ã»ã©å±é™ºï¼‰
            { id: 'TR-2024-045', lat: 35.6395, lng: 139.4438, status: 'danger', vari: 0.042, age: 85, height: 22, recommendation: 'å³åº§ã®ä¼æ¡ã‚’æ¨å¥¨', park: 'æ¡œãƒ¶ä¸˜å…¬åœ’' },
            { id: 'TR-2024-018', lat: 35.6393, lng: 139.4435, status: 'danger', vari: 0.046, age: 72, height: 18, recommendation: 'å³åº§ã®ä¼æ¡ã‚’æ¨å¥¨', park: 'æ¡œãƒ¶ä¸˜å…¬åœ’' },
            { id: 'TR-2024-091', lat: 35.6397, lng: 139.4440, status: 'warning', vari: 0.296, age: 68, height: 16, recommendation: '3ãƒ¶æœˆä»¥å†…ã®å†è¨ºæ–­', park: 'æ¡œãƒ¶ä¸˜å…¬åœ’' },
            { id: 'TR-2024-001', lat: 35.6392, lng: 139.4433, status: 'safe', vari: 0.041, age: 35, height: 12, recommendation: 'å•é¡Œãªã—', park: 'æ¡œãƒ¶ä¸˜å…¬åœ’' },
            
            // é•·æ²¼å…¬åœ’ã®æ¨¹æœ¨
            { id: 'TR-2024-104', lat: 35.6385, lng: 139.3660, status: 'danger', vari: 0.221, age: 65, height: 19, recommendation: 'å³åº§ã®å¯¾å¿œãŒå¿…è¦', park: 'é•·æ²¼å…¬åœ’' },
            { id: 'TR-2024-032', lat: 35.6381, lng: 139.3658, status: 'warning', vari: 0.037, age: 68, height: 16, recommendation: '3ãƒ¶æœˆä»¥å†…ã®å†è¨ºæ–­', park: 'é•·æ²¼å…¬åœ’' },
            { id: 'TR-2024-089', lat: 35.6384, lng: 139.3662, status: 'warning', vari: 0.038, age: 55, height: 15, recommendation: 'å®šæœŸç›£è¦–ã‚’ç¶™ç¶š', park: 'é•·æ²¼å…¬åœ’' },
            { id: 'TR-2024-002', lat: 35.6380, lng: 139.3656, status: 'safe', vari: 0.031, age: 28, height: 10, recommendation: 'å¥å…¨ãªçŠ¶æ…‹', park: 'é•·æ²¼å…¬åœ’' },
            
            // å¹³å±±åŸå€å…¬åœ’ã®æ¨¹æœ¨
            { id: 'TR-2024-127', lat: 35.6399, lng: 139.3788, status: 'danger', vari: 0.046, age: 82, height: 23, recommendation: 'ä¼æ¡ã‚’æ¤œè¨', park: 'å¹³å±±åŸå€å…¬åœ’' },
            { id: 'TR-2024-135', lat: 35.6397, lng: 139.3790, status: 'danger', vari: 0.084, age: 70, height: 17, recommendation: 'ç·Šæ€¥å¯¾å¿œãŒå¿…è¦', park: 'å¹³å±±åŸå€å…¬åœ’' },
            { id: 'TR-2024-067', lat: 35.6401, lng: 139.3786, status: 'warning', vari: 0.132, age: 48, height: 14, recommendation: '6ãƒ¶æœˆå¾Œã«å†è©•ä¾¡', park: 'å¹³å±±åŸå€å…¬åœ’' },
            { id: 'TR-2024-003', lat: 35.6396, lng: 139.3785, status: 'safe', vari: 0.085, age: 32, height: 11, recommendation: 'è‰¯å¥½', park: 'å¹³å±±åŸå€å…¬åœ’' },
            
            // å°å±±ç”°ç·‘åœ°ã®æ¨¹æœ¨
            { id: 'TR-2024-142', lat: 35.5978, lng: 139.4155, status: 'danger', vari: 0.040, age: 75, height: 21, recommendation: 'å³åº§ã®ç‚¹æ¤œãŒå¿…è¦', park: 'å°å±±ç”°ç·‘åœ°' },
            { id: 'TR-2024-023', lat: 35.5976, lng: 139.4157, status: 'warning', vari: 0.038, age: 52, height: 15, recommendation: 'æã®å‰ªå®šã‚’æ¤œè¨', park: 'å°å±±ç”°ç·‘åœ°' },
            { id: 'TR-2024-078', lat: 35.5980, lng: 139.4153, status: 'warning', vari: 0.039, age: 45, height: 13, recommendation: 'çµŒéè¦³å¯Ÿã‚’ç¶™ç¶š', park: 'å°å±±ç”°ç·‘åœ°' },
            { id: 'TR-2024-004', lat: 35.5975, lng: 139.4156, status: 'safe', vari: 0.031, age: 30, height: 10, recommendation: 'å•é¡Œãªã—', park: 'å°å±±ç”°ç·‘åœ°' },
            
            // å°å±±å†…è£å…¬åœ’ã®æ¨¹æœ¨
            { id: 'TR-2024-156', lat: 35.6063, lng: 139.3658, status: 'danger', vari: 0.037, age: 88, height: 24, recommendation: 'ä¼æ¡ã‚’å¼·ãæ¨å¥¨', park: 'å°å±±å†…è£å…¬åœ’' },
            { id: 'TR-2024-056', lat: 35.6061, lng: 139.3660, status: 'warning', vari: 0.038, age: 60, height: 17, recommendation: 'æ¬¡å›è¨ºæ–­æ™‚ã«é‡ç‚¹ç¢ºèª', park: 'å°å±±å†…è£å…¬åœ’' },
            { id: 'TR-2024-005', lat: 35.6064, lng: 139.3656, status: 'safe', vari: 0.036, age: 25, height: 9, recommendation: 'éå¸¸ã«å¥å…¨', park: 'å°å±±å†…è£å…¬åœ’' },
            
            // å…«ç‹å­éœŠåœ’ã®æ¨¹æœ¨ï¼ˆå®Ÿéš›ã®VARIå€¤ã‚’ä½¿ç”¨ï¼‰
            { id: 'TR-2024-098', lat: 35.6605, lng: 139.2660, status: 'warning', vari: 0.030, age: 58, height: 16, recommendation: 'åœŸå£Œæ”¹è‰¯ã‚’æ¤œè¨', park: 'å…«ç‹å­éœŠåœ’' },
            { id: 'TR-2024-112', lat: 35.6603, lng: 139.2662, status: 'warning', vari: 0.037, age: 50, height: 14, recommendation: 'å®šæœŸçš„ãªè¦³å¯ŸãŒå¿…è¦', park: 'å…«ç‹å­éœŠåœ’' },
            { id: 'TR-2024-076', lat: 35.6607, lng: 139.2658, status: 'warning', vari: 0.038, age: 46, height: 13, recommendation: 'æˆé•·ä¿ƒé€²å‡¦ç½®ã‚’æ¤œè¨', park: 'å…«ç‹å­éœŠåœ’' },
            { id: 'TR-2024-006', lat: 35.6602, lng: 139.2661, status: 'safe', vari: 0.031, age: 33, height: 11, recommendation: 'è‰¯å¥½ãªçŠ¶æ…‹', park: 'å…«ç‹å­éœŠåœ’' },
            { id: 'TR-2024-007', lat: 35.6606, lng: 139.2659, status: 'safe', vari: 0.032, age: 38, height: 12, recommendation: 'å¥å…¨', park: 'å…«ç‹å­éœŠåœ’' },
            
            // è¿½åŠ ã®å…«ç‹å­éœŠåœ’ãƒ‡ãƒ¼ã‚¿ï¼ˆå®Ÿéš›ã®VARIå€¤ï¼‰
            { id: 'TR-2024-008', lat: 35.6599, lng: 139.2610, status: 'danger', vari: 0.042, age: 45, height: 15, recommendation: 'ç·Šæ€¥ç‚¹æ¤œãŒå¿…è¦', park: 'å…«ç‹å­éœŠåœ’' },
            { id: 'TR-2024-009', lat: 35.6597, lng: 139.2612, status: 'danger', vari: 0.046, age: 52, height: 18, recommendation: 'å³åº§ã®å¯¾å¿œãŒå¿…è¦', park: 'å…«ç‹å­éœŠåœ’' },
            { id: 'TR-2024-010', lat: 35.6595, lng: 139.2614, status: 'warning', vari: 0.296, age: 38, height: 14, recommendation: 'å®šæœŸç›£è¦–ã‚’ç¶™ç¶š', park: 'å…«ç‹å­éœŠåœ’' },
            { id: 'TR-2024-011', lat: 35.6593, lng: 139.2616, status: 'warning', vari: 0.221, age: 42, height: 16, recommendation: 'æã®å‰ªå®šã‚’æ¤œè¨', park: 'å…«ç‹å­éœŠåœ’' },
            { id: 'TR-2024-012', lat: 35.6591, lng: 139.2618, status: 'safe', vari: 0.037, age: 29, height: 11, recommendation: 'å•é¡Œãªã—', park: 'å…«ç‹å­éœŠåœ’' }
        ];

        // ãƒãƒ¼ã‚«ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦ä¿æŒï¼‰
        window.markerGroups = {
            danger: L.markerClusterGroup({ disableClusteringAtZoom: 17 }),
            warning: L.markerClusterGroup({ disableClusteringAtZoom: 17 }),
            safe: L.markerClusterGroup({ disableClusteringAtZoom: 17 })
        };

        // ãƒãƒ¼ã‚«ãƒ¼ã®ä½œæˆ
        treeData.forEach(tree => {
            const markerIcon = L.divIcon({
                className: `custom-marker marker-${tree.status}`,
                iconSize: [24, 24]
            });

            const marker = L.marker([tree.lat, tree.lng], { icon: markerIcon });
            
            // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ä½œæˆ
            const popupContent = `
                <div class="popup-content">
                    <div class="popup-header">æ¨¹æœ¨ ${tree.id}</div>
                    <div class="popup-details">
                        <div class="popup-detail-row">
                            <span class="popup-detail-label">æ‰€åœ¨åœ°</span>
                            <span class="popup-detail-value">${tree.park || 'æœªè¨­å®š'}</span>
                        </div>
                        <div class="popup-detail-row">
                            <span class="popup-detail-label">çŠ¶æ…‹</span>
                            <span class="popup-detail-value" style="color: ${
                                tree.status === 'danger' ? '#dc2626' : 
                                tree.status === 'warning' ? '#f59e0b' : '#10b981'
                            }">
                                ${tree.status === 'danger' ? 'å±é™º' : 
                                  tree.status === 'warning' ? 'è¦æ³¨æ„' : 'å¥å…¨'}
                            </span>
                        </div>
                        <div class="popup-detail-row">
                            <span class="popup-detail-label">VARIå€¤</span>
                            <span class="popup-detail-value">${tree.vari}</span>
                        </div>
                        <div class="popup-detail-row">
                            <span class="popup-detail-label">æ¨¹é½¢</span>
                            <span class="popup-detail-value">${tree.age}å¹´</span>
                        </div>
                        <div class="popup-detail-row">
                            <span class="popup-detail-label">æ¨¹é«˜</span>
                            <span class="popup-detail-value">${tree.height}m</span>
                        </div>
                        <div class="popup-detail-row">
                            <span class="popup-detail-label">æ¨å¥¨å¯¾ç­–</span>
                            <span class="popup-detail-value">${tree.recommendation}</span>
                        </div>
                    </div>
                    <button class="popup-action" onclick="showDetails('${tree.id}')">
                        è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã‚’è¡¨ç¤º
                    </button>
                </div>
            `;
            
            marker.bindPopup(popupContent);
            window.markerGroups[tree.status].addLayer(marker);
        });

        // ã™ã¹ã¦ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’åœ°å›³ã«è¿½åŠ 
        Object.values(window.markerGroups).forEach(group => {
            group.addTo(map);
        });

        // ãƒãƒ¼ã‚«ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½
        let currentFilter = 'all';
        
        window.filterMarkers = function(status) {
            if (currentFilter === status) {
                // åŒã˜ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰å…¨è¡¨ç¤ºã«æˆ»ã™
                Object.values(window.markerGroups).forEach(group => {
                    group.addTo(map);
                });
                currentFilter = 'all';
            } else {
                // é¸æŠã—ãŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ãƒãƒ¼ã‚«ãƒ¼ã®ã¿è¡¨ç¤º
                Object.keys(window.markerGroups).forEach(key => {
                    if (key === status) {
                        window.markerGroups[key].addTo(map);
                    } else {
                        map.removeLayer(window.markerGroups[key]);
                    }
                });
                currentFilter = status;
            }
        };

        // è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤ºï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©ï¼‰
        window.showDetails = function(id) {
            alert(`æ¨¹æœ¨ ${id} ã®è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã‚’è¡¨ç¤ºã—ã¾ã™ã€‚\nï¼ˆå®Ÿéš›ã®å®Ÿè£…ã§ã¯åˆ¥ç”»é¢ã‚„ãƒ¢ãƒ¼ãƒ€ãƒ«ã§è©³ç´°æƒ…å ±ã‚’è¡¨ç¤ºï¼‰`);
        };



        // ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œã®å‡¦ç†
        function checkMobile() {
            const mobilePanel = document.querySelector('.mobile-panel');
            if (window.innerWidth <= 768) {
                mobilePanel.style.display = 'block';
            } else {
                mobilePanel.style.display = 'none';
            }
        }

        window.addEventListener('resize', checkMobile);
        checkMobile();

        // åœ°å›³ã®ã‚µã‚¤ã‚ºèª¿æ•´
        setTimeout(() => {
            map.invalidateSize();
        }, 100);

        const imageInput = document.getElementById('imageInput');
        imageInput.addEventListener('change', async (e) => {
          const file = e.target.files[0];
          if (!file) return;
          try {
            document.querySelector('.loading').style.display = 'block';
            await analyzeAndDraw(file, window.map || map, { gsd_m_per_px: 0.05 });
          } catch (err) {
            alert('åˆ†æã‚¨ãƒ©ãƒ¼: ' + err);
          } finally {
            document.querySelector('.loading').style.display = 'none';
          }
        });
        });
    </script>
</body>
</html>